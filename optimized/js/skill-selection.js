const steps=["ブキ","アタマ","フク","クツ"];const skillDisplay=document.getElementById('selections-container');let currentStepIndex=0;let userSelections={};let previousSelection=null;let coolTime=90000;let resetButtonDisabledUntil=Date.now()+coolTime;loadPreviousSelections();initializeState();function startResetButtonCountdown(){function loop(){updateResetButtonCountdown();const remainingTime=Math.max(0,resetButtonDisabledUntil-Date.now());if(remainingTime>0){requestAnimationFrame(loop);}}requestAnimationFrame(loop);}startResetButtonCountdown();displayChoices();function initializeState(){const savedSelections=sessionStorage.getItem('userSelections');const savedStepIndex=sessionStorage.getItem('currentStepIndex');const savedResetButtonDisabledUntil=sessionStorage.getItem('resetButtonDisabledUntil');if(savedSelections){userSelections=JSON.parse(savedSelections);}if(savedStepIndex){currentStepIndex=parseInt(savedStepIndex,10);currentStepIndex++;}if(savedResetButtonDisabledUntil){resetButtonDisabledUntil=parseInt(savedResetButtonDisabledUntil,10);}updateSelectionsDisplay();const allStepsCompleted=steps.every(step=>userSelections[step]);if(allStepsCompleted){document.getElementById("reset-btn").style.display='block';document.getElementById("step").style.display='none';document.getElementById("choices").style.display='none';}else{displayChoices();}}function loadPreviousSelections(){const savedPreviousSelection=sessionStorage.getItem('previousSelection');if(savedPreviousSelection){previousSelection=JSON.parse(savedPreviousSelection);updateSelectionsDisplay();}}function getRandomChoices(){const currentStep=steps[currentStepIndex];const items=database[currentStep];const unselectedItems=items.filter(item=>!userSelections[currentStep]?.includes(item));for(let i=unselectedItems.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[unselectedItems[i],unselectedItems[j]]=[unselectedItems[j],unselectedItems[i]];}return unselectedItems.slice(0,3);}function displayChoices(){if(currentStepIndex<4){if(currentStepIndex<0){currentStepIndex=0;}const currentStep=steps[currentStepIndex];document.getElementById("current-step").textContent=currentStep;let choices=[];const savedChoices=sessionStorage.getItem(`choices-${currentStep}`);if(savedChoices){choices=JSON.parse(savedChoices);}else{choices=getRandomChoices();sessionStorage.setItem(`choices-${currentStep}`,JSON.stringify(choices));}const choicesContainer=document.getElementById("choices");choicesContainer.innerHTML="";choices.forEach(choice=>{const choiceDiv=document.createElement("div");choiceDiv.className="choice-box bounce-in";choiceDiv.textContent=choice;choiceDiv.onclick=()=>selectChoice(choiceDiv,choice);choicesContainer.appendChild(choiceDiv);choicesContainer.querySelectorAll('.choice-box').forEach(box=>{box.addEventListener('animationend',()=>{box.classList.remove('bounce-in');});});});}}function selectChoice(choiceDiv,choice){const currentStep=steps[currentStepIndex];userSelections[currentStep]=choice;sessionStorage.setItem('userSelections',JSON.stringify(userSelections));sessionStorage.setItem('currentStepIndex',currentStepIndex);sessionStorage.removeItem(`choices-${currentStep}`);updateSelectionsDisplay();const choiceBoxes=document.querySelectorAll('.choice-box');choiceBoxes.forEach(box=>{box.style.pointerEvents="none";});choiceBoxes.forEach(box=>{if(box!==choiceDiv){box.classList.add('fade-out');}});choiceDiv.classList.add('slide-out');setTimeout(()=>{choiceDiv.classList.remove('slide-out');if(currentStep==="クツ"){previousSelection=userSelections;resetButtonDisabledUntil=Date.now()+coolTime;sessionStorage.setItem('resetButtonDisabledUntil',resetButtonDisabledUntil);document.getElementById("reset-btn").disabled=true;document.getElementById("reset-btn").style.display='block';document.getElementById("step").style.display='none';document.getElementById("choices").style.display='none';currentStepIndex++;setTimeout(()=>{document.getElementById("reset-btn").disabled=false;},coolTime);}if(currentStepIndex<steps.length-1){currentStepIndex++;displayChoices();}else{alert("すべてのスキルを選択しました！\n"+JSON.stringify(userSelections,null,2));}const fadeOutBoxes=document.querySelectorAll('.choice-box.fade-out');fadeOutBoxes.forEach(box=>{box.style.display="none";box.classList.remove('fade-out');});const allChoiceBoxes=document.querySelectorAll('.choice-box');allChoiceBoxes.forEach(box=>{box.style.pointerEvents="auto";});},250);}function updateSelectionsDisplay(){const container=document.getElementById("selections-container");container.innerHTML="";let currentSection=document.createElement("div");currentSection.className="section";currentSection.textContent="現在の選択:";container.appendChild(currentSection);for(const step of steps){const choice=userSelections[step]||"未選択";const skillDiv=document.createElement("div");skillDiv.className="skill-display";skillDiv.textContent=`${step}: ${choice}`;currentSection.appendChild(skillDiv);}if(previousSelection){let prevSection=document.createElement("div");prevSection.className="section";prevSection.textContent="リセット前の選択:";container.appendChild(prevSection);for(const step of steps){const choice=previousSelection[step]||"未選択";const skillDiv=document.createElement("div");skillDiv.className="skill-display";skillDiv.textContent=`${step}: ${choice}`;prevSection.appendChild(skillDiv);}}}document.getElementById("reset-btn").onclick=()=>{const confirmReset=confirm("リセットしてもよろしいですか？選択内容がクリアされます。");if(confirmReset){document.getElementById("reset-btn").disabled=true;resetSelections();const menu=document.querySelector('.nav-menu');menu.classList.remove('active');}};function updateResetButtonCountdown(){const remainingTime=Math.max(0,resetButtonDisabledUntil-Date.now());const resetButton=document.getElementById("reset-btn");if(remainingTime>coolTime){resetButton.disabled=true;resetButton.textContent=`リセット`;}else if(remainingTime>0){resetButton.disabled=true;resetButton.textContent=`リセット(${Math.ceil(remainingTime/1000)}秒後に有効)`;}else{resetButton.disabled=false;resetButton.textContent="リセット";}}function resetSelections(){const container=document.querySelector('.container');container.classList.add('slide-out');setTimeout(()=>{document.getElementById("reset-btn").style.display='none';currentStepIndex=-1;previousSelection=userSelections;sessionStorage.setItem('previousSelection',JSON.stringify(previousSelection));userSelections={};steps.forEach(step=>{sessionStorage.removeItem(`choices-${step}`);});sessionStorage.setItem('userSelections',JSON.stringify(userSelections));sessionStorage.setItem('currentStepIndex',currentStepIndex);displayChoices();document.getElementById("step").style.display='block';document.getElementById("choices").style.display='block';updateSelectionsDisplay();container.classList.add('bounce-in');},250);container.classList.remove('slide-out');container.classList.remove('bounce-in');}